---
import BackButton from '../../../components/Buttons/BackButton.astro'
import Layout from '../../../layouts/Layout.astro'
import stories from '../../../data/all_stories.json'

import Prose from '../../../components/Prose.astro'
import Title from '../../../components/Title.astro'
import AuthorSection from '../../../components/AuthorSection.astro'
import Attachments from '../../../components/Attachments.astro'
import Message from '../../../components/Message.astro'

export async function getStaticPaths() {
	return stories.map((story) => ({
		params: {
			slug: story.slugs.en,
		},
		props: {
			story,
		},
	}))
}

// Define props
const { story } = Astro.props

// Create array out of story.story.en.content by splitting the string wherever there is an \n
const contentArray = story.story.en.content.split('\n')

// console.log(story.attachments)
---

<Layout dark title='The Yemen Listening Project' header={true} switchViewButtons={false}>
	<div class='w-full max-w-5xl mx-auto mt-2 sm:mt-12 lg:mt-16 mb-8 sm:mb-24 px-4' class='story-detail-page--wrapper' id='story-wrapper'>
		<BackButton />
		<Prose>
			<div class='flex flex-col gap-10'>
				<div class='flex flex-col lg:flex-row lg:gap-x-5'>
					<div class='w-1/2'>
						<Title>{story.story.en.title || `EN TITLE ID ${story.id} MISSING`}</Title>
					</div>
					<div class='w-1/2'>
						<AuthorSection
							name={`${story.personalInfo.en.name} ${story.personalInfo.en.surname}`}
							from={story.personalInfo.en.whereFrom}
							livingIn={story.personalInfo.en.livingIn}
							age={story.contact.age}
						/>
					</div>
				</div>
				<Attachments attachments={story.attachments} />
				<Message contentArray={contentArray} />
			</div>
		</Prose>
	</div>
</Layout>

<style is:global>
	body {
		background: black;
		background-image: url('https://assets.thenewhumanitarian.org/s3fs-public/styles/responsive_large/public/2023-06/night-sky-overlay_0.png.webp');
		background-size: 100%;
		background-position: top center;
		background-repeat: no-repeat;
	}

	body * {
		color: white;
	}

	.story-w a {
		color: white;
	}

	#story-wrapper * {
		text-align: left;
	}

	#story-wrapper code {
		display: none;
	}
</style>

<script define:vars={{ slug: story.slugs.en }}>
	// Add article slug to array of read articles in lStorage

	// Retrieve the read articles array from localStorage or initialize a new one
	let readArticles = JSON.parse(localStorage.getItem('readArticles')) || []

	// Check if the current article's slug is not in the array
	if (!readArticles.some((article) => article.slug === slug)) {
		// Create an object with the current article's slug and the current timestamp
		const articleObject = {
			slug: slug,
			timestamp: new Date().toISOString(),
		}

		// Add the object to the read articles array
		readArticles.push(articleObject)

		// Save the updated array back to localStorage
		localStorage.setItem('readArticles', JSON.stringify(readArticles))
	}
</script>
